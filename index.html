<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

    <script>
        cv['onRuntimeInitialized'] = () => {
            console.log("OpenCV loaded!");
        };

        function handleFile(ev) {
            const file = ev.target.files[0];
            if (!file) return;

            const img = document.getElementById("puzzle");
            img.src = URL.createObjectURL(file);

            img.onload = () => {
                debugOCR(img);
            };
        }

        function debugOCR(imgElement) {
            console.log("=== Debug start ===");

            const src = cv.imread(imgElement);
            console.log("Loaded image:", src.cols, "x", src.rows);

            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            console.log("Converted to gray");

            let bin = new cv.Mat();
            cv.threshold(gray, bin, 180, 255, cv.THRESH_BINARY_INV);
            console.log("Binarized");

            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(
                bin,
                contours,
                hierarchy,
                cv.RETR_EXTERNAL,
                cv.CHAIN_APPROX_SIMPLE
            );

            console.log("Contours found:", contours.size());

            let validCount = 0;
            for (let i = 0; i < contours.size(); i++) {
                const rect = cv.boundingRect(contours.get(i));
                if (rect.width < 8 || rect.height < 8) continue;
                validCount++;
                console.log(
                    `Valid contour #${validCount}:`,
                    `x=${rect.x}, y=${rect.y}, w=${rect.width}, h=${rect.height}`
                );
            }

            console.log("Valid digit candidates:", validCount);
            console.log("=== Debug end ===");
        }
    </script>
</head>

<body>
    <h2>画像をアップロードしてください</h2>

    <input type="file" accept="image/*" onchange="handleFile(event)">
    <br><br>

    <img id="puzzle" style="max-width: 300px;">
</body>
</html>
