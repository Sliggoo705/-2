<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Picross Solver OCR (Improved)</title>

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 20px; }
    #preview { max-width: 95vw; margin-top: 10px; }
    #result { white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 20px; border-radius: 8px; }
  </style>
</head>

<body>
  <h1>Picross Solver OCR</h1>
  <p>ピクロス画像をアップロードすると、OCRで数字だけ正確に読み取ります。</p>

  <input type="file" id="imageInput" accept="image/*" />
  <br />
  <img id="preview" />

  <div id="result"></div>

  <script>
    const input = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const result = document.getElementById('result');

    // ---- 画像を Canvas で加工（白黒化＋解像度UP） ----
    async function preprocessImage(img) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // 高解像度で処理（OCR精度UP）
        canvas.width = img.width * 2;
        canvas.height = img.height * 2;

        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imgData.data;

        // 白黒化（しきい値 180）
        for (let i = 0; i < data.length; i += 4) {
          const avg = (data[i] + data[i+1] + data[i+2]) / 3;
          const bw = avg > 180 ? 255 : 0;
          data[i] = data[i+1] = data[i+2] = bw;
        }

        ctx.putImageData(imgData, 0, 0);
        resolve(canvas);
      });
    }

    // ---- OCR実行（数字だけ読み取る） ----
    async function runOCR(canvas) {
      return await Tesseract.recognize(
        canvas,
        'eng',
        {
          tessedit_char_whitelist: '0123456789', // 数字だけ許可
        }
      );
    }

    input.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      preview.src = URL.createObjectURL(file);
      result.textContent = '画像を処理中…';

      // 読み込み完了待ち
      preview.onload = async () => {
        // 画像を事前処理して白黒化・高精細化
        const canvas = await preprocessImage(preview);

        result.textContent = 'OCR中…（数秒かかります）';

        // OCR実行
        const { data: { text } } = await runOCR(canvas);

        result.textContent = '--- OCR結果（数字のみ） ---\n' + text;
      };
    });
  </script>

</body>
</html>
